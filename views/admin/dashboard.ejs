<%- include('../partials/header', { title: 'Dashboard', user: user, hideNavbar: false, showFooter: false}) %>

<div class="dashboard">
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header text-white">Notícias por Categoria</div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header text-white">Comentários por Notícia</div>
                <div class="card-body">
                    <canvas id="commentsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 shadow-sm">
        <div class="card-header text-white d-flex justify-content-between align-items-center">
            <span>Gerenciar Notícias</span>
            <a href="/admin/news/new" class="btn btn-light btn-sm">
                <i class="fas fa-plus-circle me-2"></i>Adicionar Notícia
            </a>
        </div>
        <div class="card-body table-responsive">
            <table id="newsTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Título</th> 
                        <th>Autor</th>
                        <th>Categoria</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados via DataTables -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<%- include('../partials/footer', {showFooter: false}) %>

<!-- Scripts específicos para o Dashboard -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar DataTable
        $('#newsTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '/api/news',
                type: 'GET'
            },
            columns: [
                { data: 'title' },
                { data: 'author' },
                { data: 'category' },
                { 
                    data: 'createdAt',
                    render: function(data, type, row) {
                        const date = new Date(data);
                        return date.toLocaleDateString();
                    }
                },
                {
                    data: '_id',
                    render: function(data, type, row) {
                        return `
                            <a href="/admin/edit/${data}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form action="/admin/news/${data}?_method=DELETE" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        `;
                    },
                    orderable: false,
                    searchable: false
                }
            ]
        });

        // Inicializar Gráficos com Chart.js via CDN
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {            
                // Gráfico de Notícias por Categoria
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                const categoryLabels = data.newsByCategory.map(item => item._id);
                const categoryCounts = data.newsByCategory.map(item => item.count);
                new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryCounts,
                            backgroundColor: [
                                '#28a745',
                                '#dc3545',
                                '#ffc107',
                                '#007bff',
                                '#ff5722',
                                '#343a40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
                
                // Função para truncar texto
                function truncateLabel(label, maxLength) {
                    if (typeof label !== 'string') return '';
                    return label.length > maxLength ? label.slice(0, maxLength) + '...' : label;
                }

                // Gráfico de Comentários por Notícia
                const commentsCtx = document.getElementById('commentsChart').getContext('2d');
                const maxLabelLength = 7;
                const commentsLabels = data.commentsByNews.map(item => {
                    return truncateLabel(String(item._id), maxLabelLength);
                });
                const commentsCounts = data.commentsByNews.map(item => item.count);
                new Chart(commentsCtx, {
                    type: 'bar',
                    data: {
                        labels: commentsLabels,
                        datasets: [{
                            label: 'Número de Comentários',
                            data: commentsCounts,
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.5)', // Verde
                                'rgba(220, 53, 69, 0.5)', // Vermelho
                                'rgba(255, 193, 7, 0.5)', // Amarelo
                                'rgba(23, 162, 184, 0.5)', // Azul Claro
                                'rgba(102, 16, 242, 0.5)', // Roxo
                                'rgba(0, 123, 255, 0.5)', // Azul
                                'rgba(255, 87, 34, 0.5)', // Laranja
                                'rgba(108, 117, 125, 0.5)', // Cinza
                                'rgba(52, 58, 64, 0.5)', // Cinza Escuro
                                'rgba(111, 66, 193, 0.5)', // Lavanda
                            ],
                            borderColor: [
                                'rgba(46, 139, 87, 1)',   // Verde Escuro
                                'rgba(178, 34, 34, 1)',   // Vermelho Escuro
                                'rgba(255, 153, 0, 1)',   // Amarelo Alaranjado
                                'rgba(0, 123, 167, 1)',   // Azul Petróleo
                                'rgba(75, 0, 130, 1)',    // Roxo Intenso
                                'rgba(0, 102, 204, 1)',   // Azul Profundo
                                'rgba(255, 69, 0, 1)',    // Laranja Intenso
                                'rgba(73, 80, 87, 1)',    // Cinza Médio
                                'rgba(33, 37, 41, 1)',    // Cinza Escuro Profundo
                                'rgba(92, 64, 178, 1)',   // Lavanda Escura
                            ],
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        
                        }
                });
            })
            .catch(err => console.error(err));
    });
</script>

